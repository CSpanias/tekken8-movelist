<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistics</title>
    <link rel="stylesheet" href="style.css">

    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="page-theory-learning-plan">
    <div class="container">
        <nav>
            <a href="index.html">Home</a> |
            <a href="movelist.html">Movelist</a> |
            <a href="punishments.html">Punishments</a> |
            <a href="combos.html">Combos</a> |
            <a href="learning-plan.html">Learning Plan</a> |
            <a href="stats.html" class="active">Statistics</a> |
            <a href="drills.html">Drills</a> |
            <a href="rank-system.html">Rank System</a> |
            <a href="theory.html">Theory</a> |
            <a href="other.html">Other</a>
        </nav>
    </div>

    <!-- Backup and Upload Section -->
    <div class="backup-section">
        <input type="file" id="uploadFile" accept=".json" onchange="uploadFromJSON(event)">
        <label for="uploadFile">Upload Backup Data</label>
        <button onclick="exportToJSON()">Backup Data</button>
    </div>

    <div id="root"></div> <!-- React app will render here -->

    <script type="text/babel">
        // Get data from localStorage or default to empty array
        const getDataFromLocalStorage = () => {
            const data = localStorage.getItem('statsData');
            return data ? JSON.parse(data) : [];
        };

        // Save data to localStorage
        const saveDataToLocalStorage = (data) => {
            localStorage.setItem('statsData', JSON.stringify(data));
        };

        function StatsTable() {
            const [filterDate, setFilterDate] = React.useState("");
            const [data, setData] = React.useState(getDataFromLocalStorage());
            const [editIndex, setEditIndex] = React.useState(null);

            const normalizeDate = (dateStr) => {
                const [yyyy, mm, dd] = dateStr.split("-");
                return `${dd}/${mm}/${yyyy}`;
            };

            // Group data by date
            const groupedData = data.reduce((acc, item) => {
                if (!acc[item.date]) acc[item.date] = [];
                acc[item.date].push(item);
                return acc;
            }, {});

            const calculatePercentage = (value, total) => {
                return total ? ((value / total) * 100).toFixed(0) + "%" : "0%";
            };

            const handleNewData = (e) => {
                e.preventDefault();
                const date = normalizeDate(e.target.date.value);
                const goal = e.target.goal.value;
                const success = parseInt(e.target.success.value);
                const defended = parseInt(e.target.defended.value);
                const whiffed = parseInt(e.target.whiffed.value);
                const newData = { date, goal, success, defended, whiffed };

                let updatedData = [...data];

                if (editIndex !== null) {
                    updatedData[editIndex] = newData;
                    setEditIndex(null);
                } else {
                    updatedData.push(newData);
                }

                setData(updatedData);
                saveDataToLocalStorage(updatedData);
                e.target.reset();
            };

            const handleEdit = (index) => {
                const item = data[index];
                document.getElementById("date").value = item.date;
                document.getElementById("goal").value = item.goal;
                document.getElementById("success").value = item.success;
                document.getElementById("defended").value = item.defended;
                document.getElementById("whiffed").value = item.whiffed;
                setEditIndex(index);
            };

            const handleDelete = (index) => {
                const updatedData = data.filter((_, i) => i !== index);
                setData(updatedData);
                saveDataToLocalStorage(updatedData);
            };

            React.useEffect(() => {
                if (window.Chart) {
                    new Chart(document.getElementById("trendChart"), {
                        type: "line",
                        data: {
                            labels: Object.keys(groupedData),
                            datasets: [
                                { label: "Success %", data: Object.keys(groupedData).map(date => groupedData[date].reduce((sum, item) => sum + item.success, 0)), borderColor: "green", fill: false },
                                { label: "Defended %", data: Object.keys(groupedData).map(date => groupedData[date].reduce((sum, item) => sum + item.defended, 0)), borderColor: "blue", fill: false },
                                { label: "Whiffed %", data: Object.keys(groupedData).map(date => groupedData[date].reduce((sum, item) => sum + item.whiffed, 0)), borderColor: "red", fill: false }
                            ]
                        }
                    });
                }
            }, [data]);

            return (
                <div>
                    <h1>Daily Stats Tracker</h1>

                    <label htmlFor="dateFilter">Filter by Date: </label>
                    <input type="date" id="dateFilter" value={filterDate} onChange={e => setFilterDate(e.target.value)} />

                    <form onSubmit={handleNewData}>
                        <label>Date: <input type="date" id="date" required /></label>
                        <label>Goal: <input type="text" id="goal" required /></label>
                        <label>Success: <input type="number" id="success" required /></label>
                        <label>Defended: <input type="number" id="defended" required /></label>
                        <label>Whiffed: <input type="number" id="whiffed" required /></label>
                        <button type="submit">{editIndex !== null ? "Update Data" : "Add Data"}</button>
                    </form>

                    {Object.keys(groupedData).map(date => (
                        <div key={date}>
                            <h3>{date}</h3>
                            <table>
                                <thead>
                                    <tr><th>Goal</th><th>Success (%)</th><th>Defended (%)</th><th>Whiffed (%)</th></tr>
                                </thead>
                                <tbody>
                                    {groupedData[date].map((item, index) => (
                                        <tr key={index}>
                                            <td>{item.goal}</td>
                                            <td>{calculatePercentage(item.success, item.success + item.defended + item.whiffed)}</td>
                                            <td>{calculatePercentage(item.defended, item.success + item.defended + item.whiffed)}</td>
                                            <td>{calculatePercentage(item.whiffed, item.success + item.defended + item.whiffed)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    ))}

                    <canvas id="trendChart"></canvas>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<StatsTable />);
    </script>
</body>
</html>
